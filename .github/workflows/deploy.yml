name: Publish to Chrome Web Store

on:
  push:
    branches: ["deploy"]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (선택) Node 빌드가 필요한 경우에만 실행
      - name: Setup Node (optional)
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build (optional)
        if: hashFiles('package.json') != ''
        run: |
          set -e
          npm ci
          npm run build

      - name: Create ZIP
        run: |
          set -e
          ZIP_NAME=extension.zip
          # 필요 파일만 정확히 포함
          zip -r "$ZIP_NAME" \
            manifest.json \
            background.js \
            meals.js \
            popup.html \
            popup.js \
            style.css \
            icons \
            2>/dev/null || true
          test -f "$ZIP_NAME" && ls -al "$ZIP_NAME"

      # ====== 여기서 먼저 구글 토큰 교환을 "직접" 점검합니다 ======
      - name: Debug Google token exchange
        env:
          CLIENT_ID: ${{ secrets.CWS_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CWS_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.CWS_REFRESH_TOKEN }}
        run: |
          set -e
          if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ] || [ -z "$REFRESH_TOKEN" ]; then
            echo "❌ Missing one of CLIENT_ID / CLIENT_SECRET / REFRESH_TOKEN"
            exit 1
          fi

          echo "🔎 Exchanging refresh_token for access_token..."
          resp=$(curl -sS -X POST https://oauth2.googleapis.com/token \
            -d client_id="$CLIENT_ID" \
            -d client_secret="$CLIENT_SECRET" \
            -d refresh_token="$REFRESH_TOKEN" \
            -d grant_type=refresh_token)

          echo "Raw response:"
          echo "$resp" | jq .

          # 실패시 탈출
          if [ "$(echo "$resp" | jq -r '.access_token // empty')" = "" ]; then
            code=$(echo "$resp" | jq -r '.error // empty')
            desc=$(echo "$resp" | jq -r '.error_description // empty')
            echo "❌ Token exchange failed: $code $desc"
            echo "   - invalid_grant: refresh_token 만료/철회 → 새로 발급 필요"
            echo "   - redirect_uri_mismatch: OAuth 클라에 OAuth Playground URI 누락"
            echo "   - invalid_client: Client ID/Secret 불일치"
            echo "   - unauthorized_client: 동의화면/테스트유저/권한 문제"
            echo "   - invalid_scope: 스코프 오타"
            exit 1
          else
            echo "✅ Token exchange succeeded"
          fi

      # ====== 실제 업로드 & 퍼블리시 ======
      - name: Upload & Publish
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          extension-id: ${{ secrets.CWS_EXTENSION_ID }}
          client-id: ${{ secrets.CWS_CLIENT_ID }}
          client-secret: ${{ secrets.CWS_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CWS_REFRESH_TOKEN }}
          file-path: extension.zip
          publish: true
          # 필요 시 테스트 채널만 배포:
          # publish-target: trustedTesters
