name: Publish to Chrome Web Store

on:
  push:
    branches: ["deploy"]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (ì„ íƒ) Node ë¹Œë“œê°€ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
      - name: Setup Node (optional)
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build (optional)
        if: hashFiles('package.json') != ''
        run: |
          set -e
          npm ci
          npm run build

      - name: Create ZIP
        run: |
          set -e
          ZIP_NAME=extension.zip
          # í•„ìš” íŒŒì¼ë§Œ ì •í™•íˆ í¬í•¨
          zip -r "$ZIP_NAME" \
            manifest.json \
            background.js \
            meals.js \
            popup.html \
            popup.js \
            style.css \
            icons \
            2>/dev/null || true
          test -f "$ZIP_NAME" && ls -al "$ZIP_NAME"

      # ====== ì—¬ê¸°ì„œ ë¨¼ì € êµ¬ê¸€ í† í° êµí™˜ì„ "ì§ì ‘" ì ê²€í•©ë‹ˆë‹¤ ======
      - name: Debug Google token exchange
        env:
          CLIENT_ID: ${{ secrets.CWS_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CWS_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.CWS_REFRESH_TOKEN }}
        run: |
          set -e
          if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ] || [ -z "$REFRESH_TOKEN" ]; then
            echo "âŒ Missing one of CLIENT_ID / CLIENT_SECRET / REFRESH_TOKEN"
            exit 1
          fi

          echo "ğŸ” Exchanging refresh_token for access_token..."
          resp=$(curl -sS -X POST https://oauth2.googleapis.com/token \
            -d client_id="$CLIENT_ID" \
            -d client_secret="$CLIENT_SECRET" \
            -d refresh_token="$REFRESH_TOKEN" \
            -d grant_type=refresh_token)

          echo "Raw response:"
          echo "$resp" | jq .

          # ì‹¤íŒ¨ì‹œ íƒˆì¶œ
          if [ "$(echo "$resp" | jq -r '.access_token // empty')" = "" ]; then
            code=$(echo "$resp" | jq -r '.error // empty')
            desc=$(echo "$resp" | jq -r '.error_description // empty')
            echo "âŒ Token exchange failed: $code $desc"
            echo "   - invalid_grant: refresh_token ë§Œë£Œ/ì² íšŒ â†’ ìƒˆë¡œ ë°œê¸‰ í•„ìš”"
            echo "   - redirect_uri_mismatch: OAuth í´ë¼ì— OAuth Playground URI ëˆ„ë½"
            echo "   - invalid_client: Client ID/Secret ë¶ˆì¼ì¹˜"
            echo "   - unauthorized_client: ë™ì˜í™”ë©´/í…ŒìŠ¤íŠ¸ìœ ì €/ê¶Œí•œ ë¬¸ì œ"
            echo "   - invalid_scope: ìŠ¤ì½”í”„ ì˜¤íƒ€"
            exit 1
          else
            echo "âœ… Token exchange succeeded"
          fi

      # ====== ì‹¤ì œ ì—…ë¡œë“œ & í¼ë¸”ë¦¬ì‹œ ======
      - name: Upload & Publish
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          extension-id: ${{ secrets.CWS_EXTENSION_ID }}
          client-id: ${{ secrets.CWS_CLIENT_ID }}
          client-secret: ${{ secrets.CWS_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CWS_REFRESH_TOKEN }}
          file-path: extension.zip
          publish: true
          # í•„ìš” ì‹œ í…ŒìŠ¤íŠ¸ ì±„ë„ë§Œ ë°°í¬:
          # publish-target: trustedTesters
